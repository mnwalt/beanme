<div class="container">
  <div class="page-header">
    <h2><%= @roaster.name %> </h2>
  </div>

  <div class="row">
    <div class="col-md-12">
      <img src="<%= @roaster.cover_photo_url %>" class="img-responsive left-block" style="max-height: 400px;">
      <br> </br>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12">
      <h3> Get to Know </h3>
    </div>
  </div>

  <div class="row">
    <div class="col-md-12 mb-2">
      <dl class="dl-horizontal">

        <% if @roaster.description != "" %>
        <dt>Story</dt>
        <dd><%= @roaster.description %></dd>
        <% end %>

        <dt>City</dt>
        <dd><%= @roaster.city %></dd>

        <dt> Avg BeanMe Rating <dt>
          <% if @roaster.reviews.count != 0 %>
          <dd>
          <% @n = @roaster.reviews.pluck(:overall_rating).count %>
          <% @avg = @roaster.reviews.pluck(:overall_rating).inject(0){|sum,x| sum + x } / @n %>

          <% if @avg < 0.75 %>
          <a>
            <span title="based on individual bean ratings">
              <i class="fa fa-star-half" aria-hidden="true"></i>
            </span>
            <small> (<%= @n %>) </small>
          </a>
          <% else %>
          <% if @avg < 1.25 %>
          <a>
            <span title="based on individual bean ratings">
              <i class="fa fa-star" aria-hidden="true"></i>
            </span>
            <small> (<%= @n %>) </small>
          </a>
          <% else %>
          <% if @avg < 1.75 %>
          <<a>
            <span title="based on individual bean ratings">
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star-half" aria-hidden="true"></i>
            </span>
            <small> (<%= @n %>) </small>
          </a>
          <% else %>
          <% if @avg < 2.25 %>
          <a>
            <span title="based on individual bean ratings">
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
            </span>
            <small> (<%= @n %>) </small>
          </a>
          <% else %>
          <% if @avg < 2.75 %>
          <a>
            <span title="based on individual bean ratings">
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star-half" aria-hidden="true"></i>
            </span>
            <small> (<%= @n %>) </small>
          </a>
          <% else %>
          <% if @avg < 3.25 %>
          <a>
            <span title="based on individual bean ratings">
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
            </span>
            <small> (<%= @n %>) </small>
          </a>
          <% else %>
          <% if @avg < 3.75 %>
          <a>
            <span title="based on individual bean ratings">
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star-half" aria-hidden="true"></i>
            </span>
            <small> (<%= @n %>) </small>
          </a>
          <% else %>
          <% if @avg < 4.25 %>
          <a>
            <span title="based on individual bean ratings">
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
            </span>
            <small> (<%= @n %>) </small>
          </a>
          <% else %>
          <% if @avg < 4.75 %>
          <a>
            <span title="based on individual bean ratings">
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star-half" aria-hidden="true"></i>
            </span>
            <small> (<%= @n %>) </small>
          </a>
          <% else %>
          <a>
            <span title="based on individual bean ratings">
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
              <i class="fa fa-star" aria-hidden="true"></i>
            </span>
            <small> (<%= @n %>) </small>
          </a>
          <% end %>
          <% end %>
          <% end %>
          <% end %>
          <% end %>
          <% end %>
          <% end %>
          <% end %>
          <% end %>
          <% else %>
          <dd>
            <a>
              <span title="not yet rated">
                <i class="fa fa-star-o" aria-hidden="true"></i>
              </span>
            </a>
          </dd>
          <% end %>

          <dt> <%= current_user.username %>'s Avg Rating <dt>
            <% if @roaster.reviews.where(:user_id => current_user).count != 0 %>
            <dd>
            <% @n = @roaster.reviews.where(:user_id => current_user).pluck(:overall_rating).count %>
            <% @avg = @roaster.reviews.where(:user_id => current_user).pluck(:overall_rating).inject(0){|sum,x| sum + x } / @n %>

            <% if @avg < 0.75 %>
            <a>
              <span title="based on individual bean ratings">
                <i class="fa fa-star-half" aria-hidden="true"></i>
              </span>
              <small> (<%= @n %>) </small>
            </a>
            <% else %>
            <% if @avg < 1.25 %>
            <a>
              <span title="based on individual bean ratings">
                <i class="fa fa-star" aria-hidden="true"></i>
              </span>
              <small> (<%= @n %>) </small>
            </a>
            <% else %>
            <% if @avg < 1.75 %>
            <<a>
              <span title="based on individual bean ratings">
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star-half" aria-hidden="true"></i>
              </span>
              <small> (<%= @n %>) </small>
            </a>
            <% else %>
            <% if @avg < 2.25 %>
            <a>
              <span title="based on individual bean ratings">
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
              </span>
              <small> (<%= @n %>) </small>
            </a>
            <% else %>
            <% if @avg < 2.75 %>
            <a>
              <span title="based on individual bean ratings">
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star-half" aria-hidden="true"></i>
              </span>
              <small> (<%= @n %>) </small>
            </a>
            <% else %>
            <% if @avg < 3.25 %>
            <a>
              <span title="based on individual bean ratings">
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
              </span>
              <small> (<%= @n %>) </small>
            </a>
            <% else %>
            <% if @avg < 3.75 %>
            <a>
              <span title="based on individual bean ratings">
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star-half" aria-hidden="true"></i>
              </span>
              <small> (<%= @n %>) </small>
            </a>
            <% else %>
            <% if @avg < 4.25 %>
            <a>
              <span title="based on individual bean ratings">
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
              </span>
              <small> (<%= @n %>) </small>
            </a>
            <% else %>
            <% if @avg < 4.75 %>
            <a>
              <span title="based on individual bean ratings">
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star-half" aria-hidden="true"></i>
              </span>
              <small> (<%= @n %>) </small>
            </a>
            <% else %>
            <a>
              <span title="based on individual bean ratings">
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
                <i class="fa fa-star" aria-hidden="true"></i>
              </span>
              <small> (<%= @n %>) </small>
            </a>
            <% end %>
            <% end %>
            <% end %>
            <% end %>
            <% end %>
            <% end %>
            <% end %>
            <% end %>
            <% end %>
            <% else %>
            <dd>
              <a>
                <span title="not yet rated">
                  <i class="fa fa-star-o" aria-hidden="true"></i>
                </span>
              </a>
            </dd>
            <% end %>

            <dt>Delivers</dt>
            <dd>
              <% if @roaster.delivers == true %>
              Yes
            </dd>
            <% else %>
            No
          </dd>
          <% end %>

          <% if @roaster.delivery_method != "" %>
          <dt>Delivery Method</dt>
          <dd><%= @roaster.delivery_method %></dd>
          <% end %>

          <% if @roaster.delivery_notes != "" %>
          <dt>Delivery Notes</dt>
          <dd><%= @roaster.delivery_notes %></dd>
          <% end %>

          <% if @roaster.delivery_geography != "" %>
          <dt>Delivery Geography</dt>
          <dd><%= @roaster.delivery_geography %></dd>
          <% end %>

          <dt></dt>
          <dd>
            <div>
              <div id="location_map" style="height: 480px;"></div>
            </div>
          </dd>

        </dl>

      </div>
    </div>

    <script src="//maps.google.com/maps/api/js?v=3.24&key=AIzaSyCOTPWiuvyyo6sKoIBzKA4-1ol-vTOIOlM"></script>
    <script src="//cdn.rawgit.com/mahnunchik/markerclustererplus/master/dist/markerclusterer.min.js"></script>
    <script>
    handler = Gmaps.build('Google');
    handler.buildMap({ provider: {}, internal: {id: 'location_map'}}, function(){
      markers = handler.addMarkers([
        {
          "lat": <%= @roaster.location_latitude %>,
          "lng": <%= @roaster.location_longitude %>,
          "infowindow": "<h5><%= @roaster.created_at %></h5><small><%= @roaster.location_formatted_address %></small>"
        }
      ]);
      handler.bounds.extendWith(markers);
      handler.fitMapToBounds();
    });
    </script>

    <div class="row">
      <div class="col-md-12">
        <h3> Beans </h3>
        <div class="table">
          <% @roaster.beans.each do |bean| %>
          <div class="col-md-3">
            <div class="panel panel-default" style="height: 515px;">
              <div class="panel-body">
                <a href="/beans/<%= bean.id %>">
                  <img src="<%= bean.image_url %>" class="img-responsive center-block" style="max-height: 150px;">
                </a>
                <hr>
                <% if bean.name.length < 24 %>
                <h4>
                  <a href="/beans/<%= bean.id %>"><%= bean.name %></a>
                  <br> </br>
                </h4>
                <% else %>
                <h4>
                  <a href="/beans/<%= bean.id %>"><%= bean.name %></a>
                </h4>
                <% end %>
                <% if bean.flavor_note_1.length < 36 %>
                <h5> <%= bean.flavor_note_1 %>
                  <br> </br>
                </h5>
                <% else %>
                <h5> <%= bean.flavor_note_1 %>
                </h5>
                <% end %>
                <div class="row">
                  <% if bean.reviews.count == 0 %>
                  <a href="/beans/<%= bean.id %>" class="btn btn-link">
                    <span title="not yet rated">
                      <i class="fa fa-star-o" aria-hidden="true"></i>
                    </span>
                  </a>
                  <% else %>
                  <% @avg = bean.reviews.pluck(:overall_rating).inject(0){|sum,x| sum + x } /bean.reviews.pluck(:overall_rating).count %>
                  <% @n = bean.reviews  .pluck(:overall_rating).count %>
                  <% if @avg < 0.75 %>
                  <a href="/beans/<%= bean.id %>" class="btn btn-link">
                    <span title="rate bean">
                      <i class="fa fa-star-half" aria-hidden="true"></i>
                    </span>
                    <small> (<%= @n %>) </small>
                  </a>
                  <% else %>
                  <% if @avg < 1.25 %>
                  <a href="/beans/<%= bean.id %>" class="btn btn-link">
                    <span title="rate bean">
                      <i class="fa fa-star" aria-hidden="true"></i>
                    </span>
                    <small> (<%= @n %>) </small>
                  </a>
                  <% else %>
                  <% if @avg < 1.75 %>
                  <a href="/beans/<%= bean.id %>" class="btn btn-link">
                    <span title="rate bean">
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star-half" aria-hidden="true"></i>
                    </span>
                    <small> (<%= @n %>) </small>
                  </a>
                  <% else %>
                  <% if @avg < 2.25 %>
                  <a href="/beans/<%= bean.id %>" class="btn btn-link">
                    <span title="rate bean">
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                    </span>
                    <small> (<%= @n %>) </small>
                  </a>
                  <% else %>
                  <% if @avg < 2.75 %>
                  <a href="/beans/<%= bean.id %>" class="btn btn-link">
                    <span title="rate bean">
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star-half" aria-hidden="true"></i>
                    </span>
                    <small> (<%= @n %>) </small>
                  </a>
                  <% else %>
                  <% if @avg < 3.25 %>
                  <a href="/beans/<%= bean.id %>" class="btn btn-link">
                    <span title="rate bean">
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                    </span>
                    <small> (<%= @n %>) </small>
                  </a>
                  <% else %>
                  <% if @avg < 3.75 %>
                  <a href="/beans/<%= bean.id %>" class="btn btn-link">
                    <span title="rate bean">
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star-half" aria-hidden="true"></i>
                    </span>
                    <small> (<%= @n %>) </small>
                  </a>
                  <% else %>
                  <% if @avg < 4.25 %>
                  <a href="/beans/<%= bean.id %>" class="btn btn-link">
                    <span title="rate bean">
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                    </span>
                    <small> (<%= @n %>) </small>
                  </a>
                  <% else %>
                  <% if @avg < 4.75 %>
                  <a href="/beans/<%= bean.id %>" class="btn btn-link">
                    <span title="rate bean">
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star-half" aria-hidden="true"></i>
                    </span>
                    <small> (<%= @n %>) </small>
                  </a>
                  <% else %>
                  <a href="/beans/<%= bean.id %>" class="btn btn-link">
                    <span title="rate bean">
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                      <i class="fa fa-star" aria-hidden="true"></i>
                    </span>
                    <small> (<%= @n %>) </small>
                  </a>
                  <% end %>
                  <% end %>
                  <% end %>
                  <% end %>
                  <% end %>
                  <% end %>
                  <% end %>
                  <% end %>
                  <% end %>
                  <% end %>
                </div>
                <h5> $<%= bean.price_per_bag %> <small> per bag </small></h5>
                <h6> <%= bean.bag_size_grams.to_i %>g / <%= (bean.bag_size_grams * 0.035274).round(1) %>oz </h6>
                <h6> <small> ($<%= (bean.price_per_bag / (bean.bag_size_grams * 0.035274)).round(2)%> per oz) </small> </h6>
                <div class="row">
                  <% if bean.labs.include?(current_user) == true %>
                  <a href="/delete_inventory/<%= bean.inventories.where(user_id: current_user.id).pluck(:id).to_sentence %>" class="btn btn-link">
                    <span title="remove favorite">
                      <i class="fa fa-heart" aria-hidden="true"></i>
                    </span>
                  </a>
                  <% else %>
                  <form action="/create_inventory" method="post">
                    <input name="authenticity_token" type="hidden" value="<%= form_authenticity_token %>">
                    <input type="hidden" name="bean_id" value="<%= bean.id %>">
                    <input type="hidden" name="user_id" value="<%= current_user.id %>">
                    <span title="make a favorite">
                      <button class="btn btn-link">
                        <i class="fa fa-heart-o" aria-hidden="true"></i>
                      </span>
                    </button>
                  </form>
                  <% end %>
                  <% if %>
                  <% bean.caffine == true %>
                  <span title="caffeinated">
                    <i class="fa fa-rocket" aria-hidden="true"></i>
                  </span>
                  <% end %>
                  <% if %>
                  <% bean.blend == true %>
                  <span title="blend">
                    <i class="fa fa-flask" aria-hidden="true"></i>
                  </span>
                  <% end %>
                  <% if %>
                  <% bean.espresso == true %>
                  <span title="espresso">
                    <i class="fa fa-coffee" aria-hidden="true"></i>
                  </span>
                  <% end %>
                </div>
              </div>
            </div>
          </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>
